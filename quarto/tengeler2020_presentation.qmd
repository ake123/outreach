---
title: "A TreeSE Tutorial with Tengeler2020"
format: revealjs
editor: visual
smaller: true
---

```{r}
#| label: setup
#| include: false
library(mia)
library(vegan)
library(scater)
library(dplyr)
library(ComplexHeatmap)
library(patchwork)
data("Tengeler2020", package = "mia")
```

## Study design {.scrollable}

. . .

Tengeler2020 is a TreeSummarizedExperiment from a study on the effects of gut microbiome on Attention-deficit/hyperactivity disorder (ADHD) in humanised mice.

```{r}
#| label: import-data
#| echo: true
data("Tengeler2020", package = "mia")
tse <- Tengeler2020
tse
```

. . .

::: columns
::: {.column width="48%"}
Young, male, germ-free C57BL/6JOlaHsd mice (n = 27) were humanised with gut microbiome from either ADHD patients (n = 3) or healthy controls (n = 3) of matched age. Notably, the mice belonged to three different cohorts.
:::

::: {.column width="52%"}
```{r}
#| label: tab-pop
tab <- table(colData(tse)$patient_status, colData(tse)$cohort)
colnames(tab) <- c("Cohort1", "Cohort2", "Cohort3")
knitr::kable(tab)
```
:::
:::

Microbiome data was obtained by 16S rRNA gene sequencing of bacterial DNA sampled from faecal pellet on a weekly basis. Then, sequence reads were assembled into Operational Taxonomic Units (OTUs) with an NG-Tax pipeline.

## Tutorials

-   [Alpha diversity](https://microbiome.github.io/outreach/tengeler_alpha_diversity.html)

-   [Beta diversity](https://microbiome.github.io/outreach/tengeler_beta_diversity.html)

-   [Community composition](https://microbiome.github.io/outreach/tengeler_community_composition.html)

## Beta diversity

. . .

### distance-based Redundance Analysis (dbRDA)

. . .

```{r}
#| label: transform-relabundance
#| echo: true
tse <- transformCounts(tse, method = "relabundance")
```

```{r}
#| label: run-brayrda
#| echo: true
tse <- runRDA(tse,
              formula = assay ~ patient_status + cohort,
              FUN = vegan::vegdist,
              method = "bray",
              assay.type = "relabundance")
```

. . .

```{r}
#| label: plot-brayrda
#| echo: true
p <- plotReducedDim(tse, "RDA",
                    colour_by = "patient_status",
                    shape_by = "cohort")
```

. . .

```{r}
#| label: fig-brayrda
#| fig-cap: RDA plot with Bray-Curtis dissimilarity.
#| fig-width: 7
#| fig-asp: 0.7
#| fig-align: center
p
```

. . .

```{r}
#| label: aitchison-workflow
#| echo: true

# perform clr transformation
tse <- transformCounts(tse,
                       assay.type = "relabundance",
                       method = "clr",
                       pseudocount = 1)

# run RDA
tse <- runRDA(tse,
              formula = assay ~ patient_status + cohort,
              FUN = vegan::vegdist,
              method = "euclidean",
              assay.type = "clr",
              name = "Aitchison")

# plot RDA
p <- plotReducedDim(tse, "Aitchison",
                    colour_by = "patient_status",
                    shape_by = "cohort")
```

. . .

```{r}
#| label: fig-aitchirda
#| fig-cap: RDA plot with Aitchison distance (CLR assay + Euclidian distance).
#| fig-width: 7
#| fig-asp: 0.7
#| fig-align: center
p
```

. . .

```{r}
#| label: test-rda
#| echo: true
rda <- attr(reducedDim(tse, "RDA"), "rda")

set.seed(123)
terms_permanova <- anova.cca(rda,
                             permutations = 99)

set.seed(123)
margin_permanova <- anova.cca(rda,
                              by = "margin",
                              permutations = 99)
```

. . .

```{r}
#| label: tbl-permanova
#| tbl-cap: Results of PERMANOVA on patient_status and cohort groups.
rda_info <- as.data.frame(rbind(terms_permanova["Model", ], margin_permanova))

rda_info[ , "Total variance"] <- rda_info["Model", "SumOfSqs"] + rda_info["Residual", "SumOfSqs"]

rda_info[ , "Explained variance"] <- rda_info[ , "SumOfSqs"] / rda_info[ , "Total variance"]

knitr::kable(rda_info)
```

. . .

```{r}
#| label: test-homogeneity
#| echo: true
homo1 <- anova(betadisper(vegdist(t(assay(tse, "relabundance"))), tse$patient_status))
homo2 <- anova(betadisper(vegdist(t(assay(tse, "relabundance"))), tse$cohort))
```

. . .

```{r}
#| label: tbl-homogeneity
#| tbl-cap: Results of betadisper test on homogeneity.
homogeneity <- as.data.frame(rbind(patient_status = homo1["Groups", ],
                                   cohort = homo2["Groups", ]))

knitr::kable(homogeneity)
```

. . .

```{r}
#| label: plot-rda
library(ggord)
library(ggplot2)
library(stringr)

coldata <- colData(tse)
variable_names <- c("patient_status", "cohort")

vec_lab_old <- rownames(rda$CCA$biplot)

vec_lab <- sapply(vec_lab_old, FUN = function(name){
    variable_name <- variable_names[ str_detect(name, variable_names) ]
    if( !any(name %in% variable_names) ){
        group_name <- unique( coldata[[variable_name]] )[ 
        which( paste0(variable_name, unique( coldata[[variable_name]] )) == name ) ]
        new_name <- paste0(variable_name, " \U2012 ", group_name)
    } else{
        new_name <- name
    }
    new_name <- expr(paste(!!new_name, " (", 
                           !!format(round( rda_info[variable_name, "Explained variance"]*100, 1), nsmall = 1), 
                           "%, ",italic("P"), " = ", 
                           !!gsub("0\\.","\\.", format(round( rda_info[variable_name, "Pr(>F)"], 3), 
                                                       nsmall = 3)), ")"))

    return(new_name)
})
names(vec_lab) <- vec_lab_old

xlab <- paste0("RDA1 (", format(round( rda$CCA$eig[[1]]/rda$CCA$tot.chi*100, 1), nsmall = 1 ), "%)")
ylab <- paste0("RDA2 (", format(round( rda$CCA$eig[[2]]/rda$CCA$tot.chi*100, 1), nsmall = 1 ), "%)")

plot <- ggord(rda, grp_in = coldata[["patient_status"]], vec_lab = vec_lab,
              alpha = 0.5,
              size = 4, addsize = -4,
              txt = 3.5, repel = TRUE, 
          ) + 
    guides(colour = guide_legend("patient_status"),
           fill = guide_legend("patient_status"),
           group = guide_legend("patient_status"),
           shape = guide_legend("patient_status"),
           x = guide_axis(xlab),
           y = guide_axis(ylab)) +
    theme( axis.title = element_text(size = 10) )
```

```{r}
#| label: fig-arrows
#| fig-cap: RDA plot of samples coloured by patient status. The arrows indicate the percentage of variance in beta diversity explained by the patient status or cohort and the respective p-value.
#| fig-width: 12
#| fig-height: 5
#| fig-align: center
plot
```

# The end
